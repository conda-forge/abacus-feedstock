{% set name = "abacus" %}
{% set version = "3.10.1" %}
{% set proc_type = "cuda" if cuda_compiler_version != "None" else "cpu" %}
{% set build = 2 %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  - url: https://github.com/deepmodeling/abacus-develop/archive/refs/tags/v{{ version }}.tar.gz
    sha256: 06873eba8a4e0bc085177a6580455b28e4b62ea8a18f8afe71a02105756d91a0
    patches:
      - 6760.patch
      - 6772.patch
  - url: https://github.com/abacusmodeling/LibRI/archive/d4f732011c6c2d115f651c38796cf7ecf823393b.tar.gz
    sha256: 12ecd8caa18b30aebca7dd53b95ef17adedf71fe822ff776c2800d1bb954362d
    folder: deps/LibRI
  - url: https://github.com/abacusmodeling/LibComm/archive/refs/tags/v0.1.1.tar.gz
    sha256: 9c47b6ea9573bffa4232c0bef63714d4c3af820c6b7539cfa6e294ca2b8ba4af
    folder: deps/LibComm

build:
  script: |
    if [[ ${cuda_compiler_version} == 12.* ]]; then
      # Below is copied from https://github.com/conda-forge/llama.cpp-feedstock/pull/76
      # This is a hotfix for https://github.com/NVIDIA/cccl/issues/4967, backporting
      # https://github.com/NVIDIA/cccl/pull/4972 on the fly for the installed headers
      CCCL_PREPROCESSOR_H_TO_PATCH="$PREFIX/include/cuda/std/__cccl/preprocessor.h"
      ROOT_DIR="$(dirname "${CCCL_PREPROCESSOR_H_TO_PATCH}")/../../../.."
      patch -p1 -d "${ROOT_DIR}" -i "${RECIPE_DIR}/cuda12_cccl_arch_all.patch"
    fi
    if [[ ${cuda_compiler_version} != "None" ]]; then
      export CMAKE_ARGS="-DUSE_CUDA=1 ${CMAKE_ARGS}"
      export CUDA_TOOLKIT_ROOT=${PREFIX}
    fi
    export CUDAARCHS=all
    cmake -B conda_build ${CMAKE_ARGS} -DCMAKE_BUILD_TYPE=Release -DENABLE_LIBXC=1 -DENABLE_LIBRI=1 -DGIT_SUBMODULE=0 -DLIBRI_DIR=$SRC_DIR/deps/LibRI -DLIBCOMM_DIR=$SRC_DIR/deps/LibComm -DBLA_VENDOR=Generic -DCMAKE_CXX_STANDARD=17
    cmake --build conda_build -j`nproc`
    cmake --install conda_build
  number: {{ build }}          # [not (unix and x86_64)]
  number: {{ build + 100 }}    # [unix and x86_64 and microarch_level == 1]
  number: {{ build + 300 }}    # [unix and x86_64 and microarch_level == 3]
  number: {{ build + 400 }}    # [unix and x86_64 and microarch_level == 4]
  skip: true  # [not linux]
  string: {{ proc_type }}_mpi_{{ mpi }}_h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}

requirements:
  build:
    - x86_64-microarch-level {{ microarch_level }}  # [unix and x86_64]
    - {{ compiler('cxx') }}
    - {{ stdlib("c") }}
    - {{ compiler('cuda') }}  # [cuda_compiler_version != "None"]
    - make
    - cmake
    - llvm-openmp  # [osx]
    - libgomp      # [linux]

  host:
    - {{ mpi }}
    - libblas
    - liblapack
    - scalapack
    - cuda-version {{ cuda_compiler_version }}  # [cuda_compiler_version != "None"]
    - libcublas-dev    # [cuda_compiler_version != "None"]
    - libcusolver-dev  # [cuda_compiler_version != "None"]
    - libcufft-dev     # [cuda_compiler_version != "None"]
    - cuda-driver-dev  # [cuda_compiler_version != "None"]
    - cuda-nvrtc-dev   # [cuda_compiler_version != "None"]
    - cuda-nvtx-dev    # [cuda_compiler_version != "None"]
    - libcurand-dev    # [cuda_compiler_version != "None"]
    - cuda-cudart-dev  # [cuda_compiler_version != "None"]
    - cuda-cccl        # [cuda_compiler_version != "None"]
    - elpa
    - elpa * mpi_{{ mpi }}_*
    - fftw
    - fftw * mpi_{{ mpi }}_*
    - cereal
    - libxc-c
    - libxc-c * cpu_*

  run:
    - {{ mpi }}
    - libxc-c
    - scalapack

test:
  commands:
    - export OMPI_MCA_plm=isolated OMPI_MCA_btl_vader_single_copy_mechanism=none OMPI_MCA_rmaps_base_oversubscribe=yes OMPI_MCA_plm_ssh_agent=false  # [mpi == "openmpi"]
    - abacus --version  # [not (aarch64 and cuda_compiler_version != "None")]
    - mpirun -n 2 abacus --version  # [not (aarch64 and cuda_compiler_version != "None")]

about:
  home: https://abacus.ustc.edu.cn/
  doc_url: https://abacus.deepmodeling.com/
  dev_url: https://github.com/deepmodeling/abacus-develop
  license: LGPL-3.0-only AND MIT
  license_family: LGPL
  license_file:
    - LICENSE
    - libnpy.LICENSE
  summary: An electronic structure package based on plane wave and numerical atomic basis sets.
  description: >
    ABACUS (Atomic-orbital Based Ab-initio Computation at UStc) is an open-source package based on density functional theory (DFT). The package utilizes both plane wave and numerical atomic basis sets with the usage of norm-conserving pseudopotentials to describe the interactions between nuclear ions and valence electrons.
    ABACUS supports LDA, GGA, meta-GGA, and hybrid functionals. Apart from single-point calculations, the package allows geometry optimizations and ab-initio molecular dynamics with various ensembles.

extra:
  recipe-maintainers:
    - njzjz
    - caic99
    - dyzheng
    - QuantumMisaka
